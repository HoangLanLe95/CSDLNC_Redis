<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý người dùng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Danh sách người dùng</h1>
        <button class="btn btn-primary mb-3" id="btnAddUser">Thêm người dùng</button>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên</th>
                    <th>Email</th>
                    <th>Vai trò</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- Dữ liệu sẽ được thêm bởi JavaScript -->
            </tbody>
        </table>
    </div>
    <!-- Modal xem chi tiết người dùng -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userDetailsModalLabel">Thông tin chi tiết người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Thông tin chi tiết người dùng sẽ được chèn vào đây -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal thêm/sửa người dùng -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Thêm người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Tên</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="userRole" class="form-label">Vai trò</label>
                            <select class="form-control" id="userRole">
                                <!-- Danh sách vai trò sẽ được thêm bởi JavaScript -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // Load danh sách người dùng
            loadUsers();

            // Load danh sách vai trò
            loadRoles();

            // Hàm tải danh sách người dùng
            function loadUsers() {
                $.ajax({
                    url: '/api/users/GetUserDetails',
                    method: 'GET',
                    success: function(data) {
                        let rows = '';
                        data.forEach(user => {
                            rows += `<tr>
                                <td>${user.id}</td>
                                <td>${user.userName}</td>
                                <td>${user.email}</td>
                                <td>${user.roleName}</td>
                                <td>
                                    <button class="btn btn-info btnViewDetails" data-id="${user.id}">Xem chi tiết</button>
                                    <button class="btn btn-warning btnEdit" data-id="${user.id}">Sửa</button>
                                    <button class="btn btn-danger btnDelete" data-id="${user.id}">Xóa</button>
                                </td>
                            </tr>`;
                        });
                        $('#userTableBody').html(rows);
                    },
                    error: function() {
                        alert('Không thể tải danh sách người dùng.');
                    }
                });
            }
                    // Hàm xử lý xem chi tiết người dùng
        $(document).on('click', '.btnViewDetails', function() {
            const userId = $(this).data('id');

            // Lấy thông tin chi tiết người dùng từ API
            $.ajax({
                url: `/api/users/${userId}/GetUserById`,
                method: 'GET',
                success: function(user) {
                    // Hiển thị popup với thông tin chi tiết
                    $('#userDetailsModal .modal-body').html(`
                        <p><strong>Họ và tên:</strong> ${user.userName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Vai trò:</strong> ${user.roleName}</p>
                        <p><strong>Địa chỉ:</strong></p>
                        <ul>
                            ${user.addresses.map(address => `<li>${address.fullAddress}, ${address.city}</li>`).join('')}
                        </ul>
                    `);
                    $('#userDetailsModal').modal('show');
                },
                error: function() {
                    alert('Không thể tải thông tin chi tiết người dùng.');
                }
            });
        });
            // Hàm tải danh sách vai trò
        function loadRoles() {
            console.log(`Hàm tải danh sách vai trò`);
            $.ajax({
                url: '/api/Users/GetAvailableRoles',  // Đảm bảo rằng URL là đúng
                method: 'GET',
                success: function(roles) {
                    console.log(roles); // Kiểm tra dữ liệu nhận được từ API
                    let options = '';
                    roles.forEach(role => {
                        options += `<option value="${role.id}">${role.name}</option>`;
                    });
                    $('#userRole').html(options); // Gắn danh sách vào select
                },
                error: function() {
                    alert('Không thể tải danh sách vai trò.');
                }
            });
        }


            // Xử lý sự kiện Thêm/Sửa
            $('#btnAddUser').click(function() {
                $('#userModalLabel').text('Thêm người dùng');
                $('#userForm')[0].reset();
                $('#userId').val('');
                $('#userModal').modal('show');
            });

            $(document).on('click', '.btnEdit', function() {
                const id = $(this).data('id');
                // Gọi API lấy thông tin chi tiết
                $.ajax({
                    url: `/api/users/${id}/GetUserById`,
                    method: 'GET',
                    success: function(user) {
                        $('#userId').val(user.id);
                        $('#userName').val(user.userName);
                        $('#userEmail').val(user.email);
                        $('#userRole').val(user.roleId); // Chọn vai trò từ ID của user
                        $('#userModalLabel').text('Sửa người dùng');
                        $('#userModal').modal('show');
                    },
                    error: function() {
                        alert('Không thể lấy thông tin người dùng.');
                    }
                });
            });

                   $('#userForm').submit(function(e) {
            e.preventDefault();
            const id = $('#userId').val();
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/users/${id}/UpdateInfo` : '/api/users/AddUser'; // Sử dụng URL thêm người dùng

            const user = {
                name: $('#userName').val(),
                email: $('#userEmail').val(),
                roleId: $('#userRole').val()
            };

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(user),
                success: function() {
                    $('#userModal').modal('hide');
                    loadUsers(); // Tải lại danh sách người dùng
                },
                error: function() {
                    alert('Không thể lưu thông tin người dùng.');
                }
            });
        });


            // Xóa người dùng
            $(document).on('click', '.btnDelete', function() {
                const id = $(this).data('id');
                if (confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
                    $.ajax({
                        url: `/api/users/${id}`,
                        method: 'DELETE',
                        success: function() {
                            loadUsers();
                            alert('Xóa người dùng thành công!')
                        },
                        error: function() {
                            alert('Không thể xóa người dùng.');
                        }
                    });
                }
            });
        });

    </script>
</body>
</html>
